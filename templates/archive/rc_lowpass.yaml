# RC Low-Pass Filter Template
# Domain: Circuits
# 展示如何將電路分析標準化為模板

template:
  id: rc_lowpass_filter
  name: "RC 低通濾波器分析"
  domain: circuits
  tags: [filter, lowpass, frequency_response, rc]
  description: |
    分析 RC 低通濾波器的頻率響應、截止頻率、相位響應。
    適用於信號處理、電源濾波、音頻電路設計。

  parameters:
    required:
      - name: resistance
        symbol: R
        type: positive_real
        unit: Ω
        description: 電阻值

      - name: capacitance
        symbol: C
        type: positive_real
        unit: F
        description: 電容值

    optional:
      - name: input_voltage_amplitude
        symbol: V_in
        type: positive_real
        default: 1.0
        unit: V
        description: 輸入電壓振幅

      - name: frequency_range
        symbol: f_range
        type: list
        default: [1, 1000000]
        unit: Hz
        description: 分析頻率範圍 [min, max]

  preconditions:
    - check: "R > 0"
      message: "電阻必須為正值"
    - check: "C > 0"
      message: "電容必須為正值"

  steps:
    - id: 1
      name: time_constant
      description: 計算 RC 時間常數
      action: multiply
      inputs: [R, C]
      outputs: [tau]
      hint:
        formula: "tau = R * C"
        sympy_mcp_tool: substitute_expression
        explanation: |
          時間常數 τ = RC
          表示電容充電到 63.2% 所需時間
      verification:
        dimension_check: true
        expected_unit: s

    - id: 2
      name: cutoff_frequency
      description: 計算截止頻率 (-3dB 點)
      action: compute
      inputs: [tau]
      outputs: [f_c]
      hint:
        formula: "f_c = 1 / (2 * pi * tau)"
        sympy_mcp_tool: substitute_expression
        explanation: |
          截止頻率定義為增益下降到 1/√2 (-3dB) 的頻率
          ω_c = 1/τ → f_c = 1/(2πτ)
      verification:
        dimension_check: true
        expected_unit: Hz

    - id: 3
      name: transfer_function
      description: 建立頻域傳輸函數
      action: symbolic
      inputs: [tau, s]  # s = jω (Laplace variable)
      outputs: [H_s]
      hint:
        formula: "H(s) = 1 / (1 + s * tau)"
        sympy_mcp_tool: create_expression
        explanation: |
          電容阻抗: Z_C = 1/(sC)
          分壓: H(s) = Z_C / (R + Z_C) = 1/(1 + sRC)
      verification:
        expected_form: "1 / (1 + s * R * C)"

    - id: 4
      name: magnitude_response
      description: 計算增益隨頻率的變化
      action: substitute
      inputs: [H_s, omega]  # s → jω
      outputs: [magnitude]
      hint:
        formula: "|H(jω)| = 1 / sqrt(1 + (ω*τ)²)"
        sympy_mcp_tool: compute_complex_magnitude
        explanation: |
          將 s = jω 代入，計算複數模
          |H(jω)| = |1 / (1 + jωτ)|
      verification:
        expected_form: "1 / sqrt(1 + (omega * tau)**2)"

    - id: 5
      name: phase_response
      description: 計算相位隨頻率的變化
      action: compute_angle
      inputs: [H_s, omega]
      outputs: [phase]
      hint:
        formula: "phi = -arctan(ω * τ)"
        sympy_mcp_tool: compute_complex_angle
        explanation: |
          相位 = arg(H(jω))
          低通濾波器的相位從 0° 到 -90° 變化
      verification:
        expected_form: "-atan(omega * tau)"

    - id: 6
      name: gain_at_frequency
      description: 計算特定頻率下的增益 (dB)
      action: compute
      inputs: [magnitude, f]
      outputs: [gain_dB]
      hint:
        formula: "gain_dB = 20 * log10(magnitude)"
        sympy_mcp_tool: substitute_expression
        explanation: |
          增益以 dB 表示：G(dB) = 20·log₁₀|H(jω)|
          在截止頻率: G = -3.01 dB

  outputs:
    - symbol: tau
      name: 時間常數
      unit: s
      description: RC 時間常數

    - symbol: f_c
      name: 截止頻率
      unit: Hz
      description: -3dB 截止頻率

    - symbol: H_s
      name: 傳輸函數
      unit: dimensionless
      description: Laplace 域傳輸函數

    - symbol: magnitude
      name: 增益函數
      unit: dimensionless
      description: |H(jω)| 隨頻率的函數

    - symbol: phase
      name: 相位函數
      unit: rad
      description: 相位隨頻率的函數

  # 特殊頻率點的驗證值
  verification_points:
    - frequency: 0
      expected_magnitude: 1.0
      expected_phase_deg: 0
      expected_gain_dB: 0

    - frequency: f_c
      expected_magnitude: 0.7071
      expected_phase_deg: -45
      expected_gain_dB: -3.01

    - frequency: "10 * f_c"
      expected_magnitude: 0.0995
      expected_phase_deg: -84.3
      expected_gain_dB: -20.04

  code_template:
    python: |
      import numpy as np
      from dataclasses import dataclass
      from typing import Tuple
      
      @dataclass
      class RCLowPassFilter:
          """
          RC Low-Pass Filter Analysis
          
          Auto-generated by NSForge from template: {{ template.id }}
          
          Parameters:
              R: Resistance [Ω]
              C: Capacitance [F]
          """
          R: float  # [Ω]
          C: float  # [F]
          
          @property
          def tau(self) -> float:
              """Time constant [s]"""
              return self.R * self.C
          
          @property
          def cutoff_frequency(self) -> float:
              """Cutoff frequency (-3dB point) [Hz]"""
              return 1 / (2 * np.pi * self.tau)
          
          def magnitude(self, f: float | np.ndarray) -> float | np.ndarray:
              """
              Magnitude response |H(jω)|
              
              Args:
                  f: Frequency [Hz]
              Returns:
                  Magnitude (dimensionless)
              """
              omega = 2 * np.pi * f
              return 1 / np.sqrt(1 + (omega * self.tau) ** 2)
          
          def phase(self, f: float | np.ndarray) -> float | np.ndarray:
              """
              Phase response ∠H(jω)
              
              Args:
                  f: Frequency [Hz]
              Returns:
                  Phase [rad]
              """
              omega = 2 * np.pi * f
              return -np.arctan(omega * self.tau)
          
          def gain_dB(self, f: float | np.ndarray) -> float | np.ndarray:
              """
              Gain in decibels
              
              Args:
                  f: Frequency [Hz]
              Returns:
                  Gain [dB]
              """
              return 20 * np.log10(self.magnitude(f))
          
          def bode_plot_data(
              self,
              f_min: float = 1,
              f_max: float = 1e6,
              points: int = 1000,
          ) -> Tuple[np.ndarray, np.ndarray, np.ndarray]:
              """
              Generate data for Bode plot
              
              Returns:
                  (frequencies, gain_dB, phase_deg)
              """
              f = np.logspace(np.log10(f_min), np.log10(f_max), points)
              gain = self.gain_dB(f)
              phase_deg = np.degrees(self.phase(f))
              return f, gain, phase_deg
      
      
      # Example usage
      if __name__ == "__main__":
          # Create filter with R=10kΩ, C=10nF
          filter = RCLowPassFilter(R=10e3, C=10e-9)
          
          print(f"Time constant: {filter.tau * 1e6:.2f} μs")
          print(f"Cutoff frequency: {filter.cutoff_frequency:.2f} Hz")
          print(f"Gain at cutoff: {filter.gain_dB(filter.cutoff_frequency):.2f} dB")

    # lcapy code generation (for symbolic circuit analysis)
    lcapy: |
      from lcapy import Circuit, j, omega, s
      
      # Define circuit
      cct = Circuit()
      cct.add('V1 1 0 {V_in}')
      cct.add('R1 1 2 {{ R }}')
      cct.add('C1 2 0 {{ C }}')
      
      # Get transfer function
      H = cct.transfer(1, 0, 2, 0)
      print(f"H(s) = {H}")
      
      # Get cutoff frequency
      fc = 1 / (2 * 3.14159 * {{ R }} * {{ C }})
      print(f"Cutoff frequency: {fc:.2f} Hz")

  references:
    - "電路學 - RC 電路暫態分析"
    - "信號與系統 - 頻率響應"
    - "模擬電子學 - 濾波器設計"

  variants:
    - id: rc_highpass_filter
      description: RC 高通濾波器
      modifications:
        - step: 3
          formula: "H(s) = s * tau / (1 + s * tau)"

    - id: rl_lowpass_filter
      description: RL 低通濾波器 (電感替代電容)
      parameter_changes:
        - remove: C
        - add:
            name: inductance
            symbol: L
            type: positive_real
            unit: H
      formula_changes:
        - tau: "L / R"

    - id: rc_lowpass_with_load
      description: 考慮負載電阻的 RC 低通
      additional_parameters:
        - name: load_resistance
          symbol: R_L
          type: positive_real
          unit: Ω
